<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MusicPlatform.Maui.ViewModels"
             xmlns:services="clr-namespace:MusicPlatform.Maui.Services"
             x:Class="MusicPlatform.Maui.Pages.JobsPage"
             x:DataType="viewmodels:JobsViewModel"
             Title="Background Jobs">

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="20">
        
        <!-- Statistics Panel -->
        <Border Grid.Row="0"
                Padding="15"
                Margin="0,0,0,10"
                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}"
                Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                StrokeThickness="1">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>
            
            <Grid ColumnDefinitions="*,*,*,*,*" ColumnSpacing="10">
                <VerticalStackLayout Grid.Column="0">
                    <Label Text="Total" 
                           FontSize="12" 
                           TextColor="Gray"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding Statistics.TotalJobs}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>

                <VerticalStackLayout Grid.Column="1">
                    <Label Text="Pending" 
                           FontSize="12" 
                           TextColor="Orange"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding Statistics.PendingJobs}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="Orange"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>

                <VerticalStackLayout Grid.Column="2">
                    <Label Text="Running" 
                           FontSize="12" 
                           TextColor="Blue"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding Statistics.RunningJobs}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="Blue"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>

                <VerticalStackLayout Grid.Column="3">
                    <Label Text="Completed" 
                           FontSize="12" 
                           TextColor="Green"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding Statistics.CompletedJobs}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="Green"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>

                <VerticalStackLayout Grid.Column="4">
                    <Label Text="Failed" 
                           FontSize="12" 
                           TextColor="Red"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding Statistics.FailedJobs}" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="Red"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Grid>
        </Border>

        <!-- Status Message -->
        <HorizontalStackLayout Grid.Row="1"
                              HorizontalOptions="Center"
                              Spacing="5"
                              Margin="0,5,0,10">
            <Label Text="●"
                   FontSize="14"
                   TextColor="LimeGreen"
                   IsVisible="{Binding Statistics.RunningJobs, Converter={StaticResource IsGreaterThanZeroConverter}}"
                   VerticalOptions="Center"/>
            <Label Text="{Binding StatusMessage}"
                   FontSize="14"
                   TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                   VerticalOptions="Center"/>
        </HorizontalStackLayout>

        <!-- Jobs List -->
        <ScrollView Grid.Row="2">
            <CollectionView ItemsSource="{Binding Jobs}"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" 
                                       VerticalOptions="Center"
                                       Spacing="10">
                        <Label Text="📋" 
                               FontSize="48"
                               HorizontalOptions="Center"/>
                        <Label Text="No jobs found" 
                               FontSize="16"
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:JobItem">
                        <Border Padding="15"
                                Margin="0,0,0,10"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                StrokeThickness="1">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8"/>
                            </Border.StrokeShape>

                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                                
                                <!-- Status Icon & Main Info -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding StatusIcon}"
                                       FontSize="32"
                                       VerticalOptions="Center"
                                       Margin="0,0,15,0"/>

                                <!-- Job Info -->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="5">
                                    <HorizontalStackLayout Spacing="10">
                                        <Label Text="{Binding Type, StringFormat='Job: {0}'}"
                                               FontSize="16"
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding RetryInfo}"
                                               FontSize="12"
                                               BackgroundColor="Orange"
                                               TextColor="White"
                                               Padding="4,2"
                                               IsVisible="{Binding HasRetries}">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" Binding="{Binding HasRetries}" Value="True">
                                                    <Setter Property="IsVisible" Value="True"/>
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </HorizontalStackLayout>
                                    <Label Text="{Binding Status}"
                                           FontSize="14"
                                           TextColor="{Binding StatusColor}"/>
                                    
                                    <!-- Progress Bar for Running Jobs -->
                                    <Grid IsVisible="{Binding Status, Converter={StaticResource StringEqualsConverter}, ConverterParameter=Running}">
                                        <ProgressBar Progress="{Binding ProgressDecimal}"
                                                     ProgressColor="{StaticResource Primary}"
                                                     HeightRequest="6"
                                                     Margin="0,5,0,0"/>
                                        <Label Text="{Binding ProgressPercentage, StringFormat='{0}%'}"
                                               FontSize="10"
                                               TextColor="{StaticResource Primary}"
                                               HorizontalOptions="End"
                                               VerticalOptions="Center"
                                               Margin="0,5,5,0"/>
                                    </Grid>
                                    
                                    <Label Text="{Binding ProgressMessage}"
                                           FontSize="12"
                                           TextColor="Blue"
                                           FontAttributes="Italic"
                                           IsVisible="{Binding ProgressMessage, Converter={StaticResource IsNotNullConverter}}"/>
                                    <Label Text="{Binding StartedAt, StringFormat='Started: {0:MMM dd, HH:mm:ss}'}"
                                           FontSize="12"
                                           TextColor="Gray"/>
                                    <Label Text="{Binding Duration}"
                                           FontSize="12"
                                           TextColor="Gray"/>
                                </VerticalStackLayout>

                                <!-- Action Buttons -->
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="2" 
                                                      Spacing="10"
                                                      VerticalOptions="Center">
                                    <Button Text="🛑"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:JobsViewModel}}, Path=CancelJobCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding CanCancel}"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            ToolTipProperties.Text="Cancel Job"/>
                                    <Button Text="🔄"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:JobsViewModel}}, Path=RetryJobCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding CanRetry}"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            ToolTipProperties.Text="Retry Job"/>
                                </HorizontalStackLayout>

                                <!-- Entity ID & Idempotency Key -->
                                <VerticalStackLayout Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Spacing="2" Margin="0,5,0,0">
                                    <Label Text="{Binding EntityId, StringFormat='Entity: {0}'}"
                                           FontSize="11"
                                           FontFamily="Consolas"
                                           TextColor="Gray"/>
                                    <Label Text="{Binding IdempotencyKey, StringFormat='Idempotency: {0}'}"
                                           FontSize="11"
                                           FontFamily="Consolas"
                                           TextColor="Gray"
                                           IsVisible="{Binding IdempotencyKey, Converter={StaticResource IsNotNullConverter}}"/>
                                </VerticalStackLayout>

                                <!-- Worker & Heartbeat Info -->
                                <Border Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                                        Padding="8"
                                        Margin="0,5,0,0"
                                        BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#2A2A2A}"
                                        Stroke="{AppThemeBinding Light=#DEE2E6, Dark=#495057}"
                                        StrokeThickness="1"
                                        IsVisible="{Binding Status, Converter={StaticResource StringEqualsConverter}, ConverterParameter=Running}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4"/>
                                    </Border.StrokeShape>
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto">
                                        <Label Grid.Row="0" Grid.Column="0"
                                               Text="{Binding WorkerInfo}"
                                               FontSize="11"
                                               TextColor="Blue"/>
                                        <Label Grid.Row="0" Grid.Column="1"
                                               Text="{Binding HeartbeatStatus, StringFormat='Heartbeat: {0}'}"
                                               FontSize="11"
                                               TextColor="{Binding IsStale, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Red|Green}"
                                               HorizontalOptions="End"/>
                                        <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                               Text="{Binding CurrentStep, StringFormat='Step: {0}'}"
                                               FontSize="11"
                                               TextColor="Purple"
                                               IsVisible="{Binding CurrentStep, Converter={StaticResource IsNotNullConverter}}"/>
                                    </Grid>
                                </Border>

                                <!-- Completed At -->
                                <Label Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2"
                                       Text="{Binding CompletedAt, StringFormat='Completed: {0:MMM dd, HH:mm:ss}'}"
                                       FontSize="12"
                                       TextColor="Gray"
                                       Margin="0,5,0,0"
                                       IsVisible="{Binding CompletedAt, Converter={StaticResource IsNotNullConverter}}"/>

                                <!-- Stale Warning -->
                                <Border Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="3"
                                        Padding="10"
                                        Margin="0,5,0,0"
                                        BackgroundColor="{AppThemeBinding Light=#FFF8DC, Dark=#4A4A2A}"
                                        Stroke="Orange"
                                        StrokeThickness="1"
                                        IsVisible="{Binding IsStale}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4"/>
                                    </Border.StrokeShape>
                                    <Label Text="⚠️ Warning: This job appears to be stale. The worker may have crashed or become unresponsive."
                                           FontSize="12"
                                           TextColor="Orange"
                                           LineBreakMode="WordWrap"/>
                                </Border>

                                <!-- Comprehensive Analysis Success (for Analysis jobs only) -->
                                <Border Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3"
                                        Padding="10"
                                        Margin="0,5,0,0"
                                        BackgroundColor="{AppThemeBinding Light=#F0F8FF, Dark=#1E3A5F}"
                                        Stroke="Green"
                                        StrokeThickness="1">
                                    <Border.IsVisible>
                                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                                            <Binding Path="Status" Converter="{StaticResource StringEqualsConverter}" ConverterParameter="Completed"/>
                                            <Binding Path="Type" Converter="{StaticResource StringEqualsConverter}" ConverterParameter="Analysis"/>
                                        </MultiBinding>
                                    </Border.IsVisible>
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4"/>
                                    </Border.StrokeShape>
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="🎉 Comprehensive Analysis Complete!"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="Green"/>
                                        <Label Text="✅ Source separation (4 stems: vocals, drums, bass, other)"
                                               FontSize="11"
                                               TextColor="DarkGreen"/>
                                        <Label Text="✅ Music Information Retrieval (BPM, key, chords, sections)"
                                               FontSize="11"
                                               TextColor="DarkGreen"/>
                                        <Label Text="✅ Audio Flamingo AI analysis (genre, mood, instruments)"
                                               FontSize="11"
                                               TextColor="DarkGreen"/>
                                        <Label Text="✅ Individual stem analysis with instrument features"
                                               FontSize="11"
                                               TextColor="DarkGreen"/>
                                        <Label Text="✅ Bark training dataset generated with structured prompts"
                                               FontSize="11"
                                               TextColor="DarkGreen"/>
                                        <Label Text="Ready for AI model training and generation!"
                                               FontSize="12"
                                               FontAttributes="Italic"
                                               TextColor="Blue"/>
                                    </VerticalStackLayout>
                                </Border>

                                <!-- Error Message -->
                                <Border Grid.Row="6" Grid.Column="0" Grid.ColumnSpan="3"
                                        Padding="10"
                                        Margin="0,5,0,0"
                                        BackgroundColor="{AppThemeBinding Light=#FFF3F3, Dark=#3D1F1F}"
                                        Stroke="Red"
                                        StrokeThickness="1"
                                        IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullConverter}}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding ErrorMessage, StringFormat='Error: {0}'}"
                                           FontSize="12"
                                           TextColor="Red"
                                           LineBreakMode="WordWrap"/>
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <!-- Refresh Button -->
        <Button Grid.Row="3"
                Text="🔄 Refresh"
                Command="{Binding RefreshCommand}"
                IsEnabled="{Binding IsRefreshing, Converter={StaticResource InvertedBoolConverter}}"
                Margin="0,10,0,0"
                HeightRequest="50"/>
    </Grid>
</ContentPage>
