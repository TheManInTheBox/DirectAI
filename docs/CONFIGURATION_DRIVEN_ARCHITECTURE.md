# Configuration-Driven Architecture
## One Codebase, Multiple Environments

This document explains how the **same codebase** runs both locally (Docker Desktop) and in Azure (cloud production).

---

## üéØ Design Principle

**"Configuration over Duplication"**

- ‚úÖ **Same .NET API code** ‚Üí Works locally and in Azure
- ‚úÖ **Same Python workers** ‚Üí Docker containers run anywhere  
- ‚úÖ **Same MAUI app** ‚Üí Cross-platform desktop/mobile client
- ‚úÖ **Configuration only** ‚Üí Different connection strings, URLs, auth

---

## üèóÔ∏è Architecture Comparison

### Local Development (Docker Desktop)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MAUI App    ‚îÇ
‚îÇ (localhost)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ HTTP
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  .NET API (Docker)      ‚îÇ
‚îÇ  Port: 5000             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ             ‚îÇ
    ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇPostgreSQL‚îÇ  ‚îÇ  Azurite  ‚îÇ
‚îÇ(Docker)  ‚îÇ  ‚îÇ  (Docker) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ             ‚îÇ
    ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Python Workers (Docker) ‚îÇ
‚îÇ  - Analysis              ‚îÇ
‚îÇ  - Generation            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Azure Production
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MAUI App    ‚îÇ
‚îÇ (any device) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ HTTPS
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  .NET API (App Service) ‚îÇ
‚îÇ  + Durable Functions    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ             ‚îÇ
    ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇAzure SQL ‚îÇ  ‚îÇ Blob       ‚îÇ
‚îÇDatabase  ‚îÇ  ‚îÇ Storage    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ             ‚îÇ
    ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AKS (Kubernetes)        ‚îÇ
‚îÇ  - Analysis Pods (CPU)   ‚îÇ
‚îÇ  - Generation Pods (GPU) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚öôÔ∏è Configuration Strategy

### Environment Detection

```csharp
public class AppSettings
{
    public string Environment { get; set; } // "Local" or "Azure"
    
    public bool IsLocal => Environment == "Local";
    public bool IsAzure => Environment == "Azure";
}
```

### Connection Strings

| Environment | Database | Storage |
|------------|----------|---------|
| **Local** | PostgreSQL (Docker) | Azurite (localhost:10000) |
| **Azure** | Azure SQL Database | Azure Blob Storage (Managed Identity) |

### Worker URLs

| Environment | Analysis Worker | Generation Worker |
|------------|-----------------|-------------------|
| **Local** | http://localhost:8001 | http://localhost:8002 |
| **Azure** | http://analysis-worker.music-platform.svc.cluster.local:8080 | http://generation-worker.music-platform.svc.cluster.local:8080 |

### Orchestration

| Environment | Type | Storage |
|------------|------|---------|
| **Local** | In-Memory Queue | None (memory-based) |
| **Azure** | Durable Functions | Azure Storage Tables |

---

## üîê Authentication

### Local Development
```json
{
  "Authentication": {
    "Enabled": false
  }
}
```
**No auth required** - faster iteration

### Azure Production
```json
{
  "Authentication": {
    "Enabled": true,
    "AzureAd": {
      "Instance": "https://login.microsoftonline.com/",
      "TenantId": "{your-tenant-id}",
      "ClientId": "{your-client-id}"
    }
  }
}
```
**Azure AD authentication** - secure production access

---

## üì¶ Component Abstraction

### Storage Service

```csharp
public interface IStorageService
{
    Task<string> UploadAudioAsync(Stream audioStream, string fileName);
    Task<Stream> DownloadAudioAsync(string blobUri);
}

// Implementation switches based on configuration
public class StorageService : IStorageService
{
    public StorageService(IConfiguration config)
    {
        if (config["BlobStorage:UseManagedIdentity"] == "true")
        {
            // Azure: Managed Identity
            _client = new BlobServiceClient(
                new Uri($"https://{config["BlobStorage:AccountName"]}.blob.core.windows.net"),
                new DefaultAzureCredential());
        }
        else
        {
            // Local: Connection string
            _client = new BlobServiceClient(config["BlobStorage:ConnectionString"]);
        }
    }
}
```

### Database Context

```csharp
public class MusicPlatformDbContext : DbContext
{
    protected override void OnConfiguring(DbContextOptionsBuilder options)
    {
        var connectionString = _configuration.GetConnectionString("DefaultConnection");
        
        if (connectionString.Contains("Host="))
        {
            // PostgreSQL (local)
            options.UseNpgsql(connectionString);
        }
        else
        {
            // SQL Server (Azure)
            options.UseSqlServer(connectionString);
        }
    }
}
```

### Orchestration Service

```csharp
public interface IOrchestrationService
{
    Task<string> StartAnalysisAsync(Guid audioFileId);
    Task<JobStatus> GetStatusAsync(string jobId);
}

// Local: Simple in-memory queue
public class InMemoryOrchestrationService : IOrchestrationService
{
    private readonly ConcurrentDictionary<string, JobStatus> _jobs = new();
    // ...
}

// Azure: Durable Functions client
public class DurableFunctionsOrchestrationService : IOrchestrationService
{
    private readonly IDurableClient _client;
    // ...
}
```

---

## üê≥ Docker Images

### Same Dockerfile, Different Deployment

**Analysis Worker Dockerfile:**
```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8080
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8080"]
```

**Runs in:**
- ‚úÖ Docker Compose (local)
- ‚úÖ Azure Kubernetes Service (cloud)

No code changes needed!

---

## üì± MAUI Frontend

### Configuration

```csharp
public class ApiSettings
{
    public string BaseUrl { get; set; }
    
    // Set at runtime based on environment
    public static string GetApiUrl()
    {
#if DEBUG
        return "http://localhost:5000"; // Local development
#else
        return "https://music-api.azurewebsites.net"; // Azure production
#endif
    }
}
```

### API Client

```csharp
public class MusicApiClient
{
    private readonly HttpClient _httpClient;
    
    public MusicApiClient()
    {
        _httpClient = new HttpClient
        {
            BaseAddress = new Uri(ApiSettings.GetApiUrl())
        };
    }
    
    public async Task<AudioFile> UploadAudioAsync(Stream audio, string fileName)
    {
        var content = new MultipartFormDataContent();
        content.Add(new StreamContent(audio), "file", fileName);
        
        var response = await _httpClient.PostAsync("/api/audio", content);
        return await response.Content.ReadFromJsonAsync<AudioFile>();
    }
}
```

**Same code works for both local and Azure!**

---

## üöÄ Deployment

### Local Development

```powershell
# Start everything
docker-compose up -d

# MAUI app automatically connects to localhost:5000
```

### Azure Deployment

```powershell
# Deploy infrastructure
az deployment group create --template-file infrastructure/main.bicep

# Push Docker images to ACR
docker tag music-analysis-worker myacr.azurecr.io/analysis-worker:v1
docker push myacr.azurecr.io/analysis-worker:v1

# Deploy to AKS
kubectl apply -f k8s/

# Publish API to App Service
dotnet publish -c Release
az webapp deployment source config-zip --src api.zip

# MAUI app automatically connects to Azure URL
```

---

## üß™ Testing

### Unit Tests
```csharp
// Use in-memory database for both local and CI
services.AddDbContext<MusicPlatformDbContext>(options =>
    options.UseInMemoryDatabase("TestDb"));
```

### Integration Tests
```csharp
// Mock external services
services.AddTransient<IWorkerClient, MockWorkerClient>();
```

### End-to-End Tests
```csharp
// Can run against local Docker or Azure
var apiUrl = Environment.GetEnvironmentVariable("TEST_API_URL") 
             ?? "http://localhost:5000";
```

---

## üìä Monitoring

### Local Development
- Console logs
- Docker logs: `docker-compose logs -f`
- PgAdmin for database inspection

### Azure Production
- Application Insights
- Azure Monitor
- Log Analytics
- Custom dashboards

---

## ‚úÖ Benefits

### Single Codebase
- ‚úÖ No environment-specific branches
- ‚úÖ Same bugs in dev and prod
- ‚úÖ Easy to test locally before deploying

### Configuration-Driven
- ‚úÖ Change behavior without code changes
- ‚úÖ Environment variables in production
- ‚úÖ appsettings.json in development

### Cost-Effective
- ‚úÖ Free local development (Docker Desktop)
- ‚úÖ Only pay for Azure when needed
- ‚úÖ Easy to scale up/down

### Developer Experience
- ‚úÖ Fast local iteration
- ‚úÖ Test full pipeline locally
- ‚úÖ Deploy with confidence

---

## üîÑ Migration Path

### Start Local (Week 1-8)
1. Build features in Docker
2. Test with MAUI app
3. Use PostgreSQL and Azurite
4. No cloud costs

### Deploy to Azure (Week 9+)
1. Change configuration only
2. Deploy infrastructure with Bicep
3. Push Docker images to ACR
4. Update MAUI app URL

### Hybrid (Ongoing)
1. Develop locally
2. Test in staging (Azure)
3. Deploy to production (Azure)

---

## üìÅ Project Structure

```
DirectAI/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ MusicPlatform.Api/              # .NET API (works everywhere)
‚îÇ   ‚îú‚îÄ‚îÄ MusicPlatform.Domain/           # Shared domain models
‚îÇ   ‚îú‚îÄ‚îÄ MusicPlatform.Infrastructure/   # Storage, DB, abstractions
‚îÇ   ‚îî‚îÄ‚îÄ MusicPlatform.Maui/             # Cross-platform frontend
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îú‚îÄ‚îÄ analysis/                       # Python worker (Docker)
‚îÇ   ‚îî‚îÄ‚îÄ generation/                     # Python worker (Docker)
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ schema.sql                      # Works for PostgreSQL & SQL Server
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îî‚îÄ‚îÄ main.bicep                      # Azure deployment
‚îú‚îÄ‚îÄ docker-compose.yml                  # Local orchestration
‚îî‚îÄ‚îÄ appsettings.*.json                  # Environment configs
```

---

## üéØ Summary

**One Codebase, Multiple Environments**

- Same .NET API ‚Üí App Service or Docker
- Same Python workers ‚Üí Docker Compose or AKS
- Same MAUI app ‚Üí Any device
- Different configs ‚Üí Connection strings, URLs, auth

**Benefits:**
- Faster development
- Lower maintenance
- Fewer bugs
- Easy deployment

**This is production-ready architecture done right.** üöÄ
